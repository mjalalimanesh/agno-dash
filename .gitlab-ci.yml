stages:
  - build
  - deploy

variables:
  DOCKER_API_VERSION: "1.45"
  IMAGE_TAG: $CI_REGISTRY_IMAGE/dash:$CI_COMMIT_SHORT_SHA
  CONTAINER_NAME: dash-api

before_script:
  - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY

build_prod:
  stage: build
  script:
    - docker build -t $IMAGE_TAG .
    - docker tag $IMAGE_TAG $CI_REGISTRY_IMAGE/dash:latest
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE/dash:latest
  tags:
    - ai-ticketing
  only:
    - tags

deploy:
  stage: deploy
  script:
    - docker pull $IMAGE_TAG
    - docker stop $CONTAINER_NAME || true
    - docker rm $CONTAINER_NAME || true
    - |
      docker run -d \
      --restart always \
      --name $CONTAINER_NAME \
      -p 8081:8081 \
      -v /opt/docker-data/dash:/data \
      -e DATA_DIR=/data \
      -e RUNTIME_ENV=prd \
      -e WAIT_FOR_DB=True \
      -e DB_HOST="$DB_HOST" \
      -e DB_PORT="${DB_PORT:-5432}" \
      -e DB_USER="${DB_USER:-ai}" \
      -e DB_PASS="${DB_PASS:-ai}" \
      -e DB_DATABASE="${DB_DATABASE:-ai}" \
      -e "ANALYTICS_DB_MAIN=${ANALYTICS_DB_MAIN:-}" \
      -e OPENAI_API_KEY="$OPENAI_API_KEY" \
      -e EXA_API_KEY="$EXA_API_KEY" \
      $IMAGE_TAG uvicorn app.main:app --host 0.0.0.0 --port 8081
  tags:
    - ai-ticketing
  only:
    - tags

seed:
  stage: deploy
  needs: ["deploy"]
  when: manual
  allow_failure: true
  script:
    - docker exec $CONTAINER_NAME python -m dash.scripts.load_data
    - docker exec $CONTAINER_NAME python -m dash.scripts.load_knowledge
  tags:
    - ai-ticketing
  only:
    - tags
