stages:
  - build
  - deploy

variables:
  DOCKER_API_VERSION: "1.45"
  IMAGE_TAG: $CI_REGISTRY_IMAGE/dash:$CI_COMMIT_SHORT_SHA
  CONTAINER_NAME: dash-api

before_script:
  - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY

build_prod:
  stage: build
  script:
    - docker build -t $IMAGE_TAG .
    - docker tag $IMAGE_TAG $CI_REGISTRY_IMAGE/dash:latest
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE/dash:latest
  tags:
    - ai-ticketing
  only:
    - tags

deploy:
  stage: deploy
  script:
    - docker pull $IMAGE_TAG
    - export IMAGE_TAG=$IMAGE_TAG
    - mkdir -p /opt/docker-data/dash-db /opt/docker-data/dash
    - docker compose -f compose.yaml -f compose.prod.yaml up -d --remove-orphans
    - echo "--- Waiting 15s for containers to start ---"
    - sleep 15
    - docker ps --filter "name=dash" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    - docker logs --tail=80 $CONTAINER_NAME
  tags:
    - ai-ticketing
  only:
    - tags

seed:
  stage: deploy
  needs: ["deploy"]
  when: manual
  allow_failure: true
  script:
    - docker exec $CONTAINER_NAME python -m dash.scripts.load_data
    - docker exec $CONTAINER_NAME python -m dash.scripts.load_knowledge
  tags:
    - ai-ticketing
  only:
    - tags
