stages:
  - build
  - deploy

variables:
  DOCKER_API_VERSION: "1.45"

  # Image naming
  IMAGE_NAME: dash
  IMAGE_TAG: $CI_REGISTRY_IMAGE/$IMAGE_NAME:$CI_COMMIT_TAG
  IMAGE_LATEST: $CI_REGISTRY_IMAGE/$IMAGE_NAME:latest

  # Runtime naming
  CONTAINER_NAME: dash-api
  DOCKER_NETWORK: dash

  # Persistent host path on the VM (must exist / be writable by the runner user)
  HOST_DATA_ROOT: /opt/docker-data/dash

  # App config
  APP_PORT: "8000"
  DATA_DIR: /data
  RUNTIME_ENV: prd
  WAIT_FOR_DB: "True"

before_script:
  - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY

build_prod:
  stage: build
  script:
    - docker build -t $IMAGE_TAG .
    - docker tag $IMAGE_TAG $IMAGE_LATEST
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
  tags:
    - ai-ticketing
  only:
    - tags

deploy_prod:
  stage: deploy
  script:
    - docker pull $IMAGE_TAG
    - docker network create $DOCKER_NETWORK || true
    - mkdir -p $HOST_DATA_ROOT

    # API container (connects to external Postgres via DB_HOST, DB_PORT, etc.)
    - docker stop $CONTAINER_NAME || true
    - docker rm $CONTAINER_NAME || true
    - |
      docker run -d \
      --restart always \
      --name $CONTAINER_NAME \
      --network $DOCKER_NETWORK \
      -p $APP_PORT:8000 \
      -v $HOST_DATA_ROOT:$DATA_DIR \
      -e DATA_DIR="$DATA_DIR" \
      -e RUNTIME_ENV="$RUNTIME_ENV" \
      -e WAIT_FOR_DB="$WAIT_FOR_DB" \
      -e DB_HOST="$DB_HOST" \
      -e DB_PORT="${DB_PORT:-5432}" \
      -e DB_USER="${DB_USER:-ai}" \
      -e DB_PASS="${DB_PASS:-ai}" \
      -e DB_DATABASE="${DB_DATABASE:-ai}" \
      -e OPENAI_API_KEY="$OPENAI_API_KEY" \
      -e EXA_API_KEY="$EXA_API_KEY" \
      $IMAGE_TAG uvicorn app.main:app --host 0.0.0.0 --port 8000
  tags:
    - ai-ticketing
  only:
    - tags

seed_prod:
  stage: deploy
  needs: ["deploy_prod"]
  when: manual
  allow_failure: true
  script:
    - docker exec $CONTAINER_NAME python -m dash.scripts.load_data
    - docker exec $CONTAINER_NAME python -m dash.scripts.load_knowledge
  tags:
    - ai-ticketing
  only:
    - tags
